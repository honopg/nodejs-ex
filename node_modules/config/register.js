
var crypto = require('crypto');
var rand = require('csprng');
var mongoose = require('mongoose');
var user = require('config/models');
 
 
 
exports.register = function(name,lastname,typeuser,email,password,callback) {
 
	//var y = /^[\\w-]+(\\.[\\w-]+)*@([A-Za-z0-9.])*(uniovi.es{1})$/;
	var w = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)*(uniovi.es{1})$/;
	var k = password;
	var s = /Alumno/;
	var q = /Profesor/;
	var e = /^([uU][oO]).*([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)*(uniovi.es{1})$/;
	//var r = "Alumno";


	if ( name != null || name != undefined){
	if ( email != null || email != undefined){
	if ( w.test(email) ){
	if ( typeuser != null || typeuser != undefined){
	if ( s.test(typeuser) && e.test(email) || q.test(typeuser) && !e.test(email)) {
	if (password != null && password.length > 5 ) {
	
		var temp =rand(160, 36);
		var newpass = temp + password;
		var token = crypto.createHash('sha512').update(email +rand).digest("hex");
		var hashed_password = crypto.createHash('sha512').update(newpass).digest("hex");

		var newuser = new user({
			token: token,
			name : name,
			lastname : lastname,
			email: email,
			typeuser: typeuser,
			hashed_password: hashed_password,
			salt :temp });
 
	user.find({email: email},function(err,users){
 
		var len = users.length;
 
		if(len == 0){
			newuser.save(function (err) {
 
			//callback({'response':"Sucessfully Registered"});
			callback("Sucessfully Registered");
		});
		}else{
 
			//callback({'response':"Email already Registered"});
			callback("Email already Registered");
			}
	}); 
	}
	else{
 
		//callback({'response':"Password Weak"});
		callback("Password Weak");
		} 
	}else{
 
		//callback({'response':"Your email is invalid for that occupation"});
		callback("Your email is invalid for that occupation");
		}
	}else{
 
	//callback({'response':"Typeuser is required"});
	callback("Typeuser is required");
		}
	}else{
 
	//callback({'response':"Email Not Valid"});
	callback("Email Not Valid");
		}
	}else{
 
	//callback({'response':"Email is required"});
	callback("Email is required");
		}
	}else{
 
    //callback({'response':"Name is required"});
	callback("Name is required");
		}
}